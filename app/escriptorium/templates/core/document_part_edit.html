{% extends 'core/document_nav.html' %}
{% load i18n staticfiles thumbnail json %}

{% block nav-edit-active %}active{% endblock %}

{% block extra_nav %}
<div id="part-name" class="navbar-brand mx-3"></div>
<div class="ml-auto">
  <button id="source-panel-btn" type="button" data-target="source" class="open-panel nav-item btn btn-secondary" title="{% trans "Source Image" %}"><i class="fas fa-eye"></i></button>
  <button id="binar-panel-btn" type="button" data-target="binar" class="open-panel nav-item btn btn-secondary" title="{% trans "Binarization" %}"><i class="fas fa-adjust"></i></button>
  <button id="seg-panel-btn" type="button" data-target="seg" class="open-panel nav-item btn btn-secondary" title="{% trans "Segmentation" %}"><i class="fas fa-align-left"></i></button>
  <button id="trans-panel-btn" type="button" data-target="trans" class="open-panel nav-item btn btn-secondary" title="{% trans "Transcription" %}"><i class="fas fa-language"></i></button>
</div>
{% endblock %}

{% block bodyclass %}part-edit-body{% endblock %}

{% block nav_content %}
<div class="row no-transition">
  <div class="col-sides"></div>
  <div id="source-tools" class="panel-tools col">
    <i title="{% trans 'Source Panel' %}" class="panel-icon fas fa-eye"></i>
  </div>
  <div id="binar-tools" class="panel-tools col">
    <i title="{% trans 'Binarization Panel' %}" class="panel-icon fas fa-adjust"></i>
  </div>
  <div id="seg-tools" class="panel-tools col">
    <div class="form-row">
      <div class="col-auto mr-1">
        <i title="{% trans 'Segmentation Panel' %}" class="panel-icon fas fa-align-left"></i>
      </div>
      <div class="col mr-1 mb-2">
        <button id="undo" title="{% trans "Undo. (Ctrl+Z)" %}" class="btn btn-outline-dark ml-3 fas fa-undo" autocomplete="off" disabled></button>
        <button id="redo" title="{% trans "Redo. (Ctrl+Y)" %}" class="btn btn-outline-dark fas fa-redo" autocomplete="off" disabled></button>
        
        <!--button id="toggle-regions" title="{% trans "Switch to region mode. (R)" %}" class="btn btn-info ml-3 fas fa-th-large"></button-->
        <button id="toggle-masks" title="{% trans "Show line masks. (M)" %}" class="btn btn-info ml-3 fas fa-mask"></button>
        <button id="split-lines" title="{% trans "Cut through lines. (C)" %}" class="btn ml-3 btn-info fas fa-cut"></button>

        {# help #}
        <button id="segmentation-help" title="{% trans "Help." %}" class="btn btn-info fas fa-question help"></button>
        <div class="alert alert-primary help-text hide">
          <button type="button" class="close" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <div>
            {% blocktrans %}
            <p>
              <b>Left click</b> on the image to <u>create</u> new line, <b>Right click</b> to <b>add points</b> and <b>Left click</b> to <u>finish</u> it.
              <br/>You can keep the mouse button pressed for free drawing.
              <br/>Hitting <b>escape</b> while drawing a line <u>cancels</u> it.
            </p>
            <p>
              <b>Left click</b> on a line to selects it, then you can drag it's closest control point.
              <br/><b>Double click</b> on the line will create a <u>new control point</u> at the mouse location.
              <br/>You can go through your changes <u>history</u> back and forth with <b>Ctrl+Z</b>(undo) and <b>Ctrl+Y</b>(redo) or by using the corresponding buttons.
            </p>
            <p>
              <b>Shift+click</b> allows to add or remove a line from the <u>selection</u>,
              <b>shift and drag</b> creates a <u>lasso</u> selection tool that allows to select control points (they then appear black).
              <br/><b>Ctrl+drag</b> allows to move all the selected control points at once (or the selected lines if no control points are selected).

              <br/>The red trash <i class="text-danger fas fa-trash"></i> button allows to <b>delete</b> selected <b>lines/regions</b>,
              <br/>The yellow trash button <i class="text-warning fas fa-trash"></i> only <b>deletes</b> selected control <b>points</b>.
            </p>
            {% endblocktrans %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="trans-tools" class="panel-tools col">
    <div class="form-row">
      <div class="col-auto mr-1">
        <i title="{% trans 'Transcription Panel' %}" class="panel-icon fas fa-language"></i>
      </div>
      <div class="col">
        <select id="document-transcriptions" title="{% trans 'Transcription' %}" class="form-control custom-select mb-2">
          {% for transcription in document.transcriptions.all %}
          <option value="{{ transcription.pk }}">{{ transcription.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>
  <div class="col-sides"></div>
  {#</div> #}
  <div class="w-100"></div>
  {# <div class="row" style="position: relative;"> #}
    <div class="col-sides">
      {% if document.read_direction == 'rtl' %}
      <a id="next-part" href="#" data-target="{{next.pk}}" class="nav-btn nav-next" title="{% trans "Next" %}"><i class="fas fa-angle-left"></i></a>
      {% else %}
      <a id="prev-part" href="#" data-target="{{previous.pk}}" class="nav-btn nav-prev" title="{% trans "Previous" %}"><i class="fas fa-angle-left"></i></a>
      {% endif %}
      <div>
        <button id="zoom-reset" class="btn btn-sm btn-info" title="{% trans "Reset zoom." %}"><i class="fas fa-search-minus"></i></button>
        <input id="zoom-range" type="range" name="zoom-range" class="form-control-range mt-1" orient="vertical" min="" max="" step="0.2">
      </div>
  </div>
  <div id="source-panel" class="col panel">
    <div class="img-container">
      <div class="zoom-container">
        <img id="part-img" src="{# part.image|thumbnail_url:'large' #}"/>
        <div class="overlay">
          <svg width="100%" height="100%">
            <defs>
              <mask id="source-overlay">
                <rect width="100%" height="100%" fill="white"/>
                <polygon points=""/>
              </mask>
            </defs>
            <rect fill="grey" opacity="0.3" width="100%" height="100%" mask="url(#source-overlay)" />
          </svg>
        </div>
      </div>
    </div>
  </div>
  
  <div id="binar-panel" class="col panel">
    <div class="img-container">
      <div class="zoom-container">
      <img id="part-img" src="{# part.bw_image|thumbnail_url:'large' #}"/>
      <div class="overlay">
        <svg width="100%" height="100%">
          <defs>
            <mask id="bin-overlay">
              <rect width="100%" height="100%" fill="white"/>
              <polygon points=""/>
            </mask>
          </defs>
          <rect fill="grey" opacity="0.3" width="100%" height="100%" mask="url(#bin-overlay)" />
        </svg>
      </div>
      </div>
    </div>
  </div>
  
  <div id="seg-panel" class="col panel">
    <div class="img-container">
      <div class="zoom-container">
        <img id="part-img" src="{# part.image|thumbnail_url:'large' #}"/>
        <div id="segmentation-overlay" class="overlay">
          <svg width="100%" height="100%">
            <defs>
              <mask id="seg-overlay">
                <rect width="100%" height="100%" fill="white"/>
                <polygon points=""/>
              </mask>
            </defs>
            <rect fill="grey" opacity="0.3" width="100%" height="100%" mask="url(#seg-overlay)" />
          </svg>
        </div>        
      </div>
      <button id="delete-point" title="{% trans "Delete selected points. (ctrl+suppr)" %}" class="hide btn btn-warning m-1 fas fa-trash"></button>
      <button id="merge-selection" title="{% trans "Merge selected lines." %}" class="hide btn btn-info fas m-1 fa-compress-arrows-alt"></button>
      <button id="reverse-selection" title="{% trans "Reverse selected lines." %}" class="hide btn btn-info fas m-1 fa-arrows-alt-h"></button>
      <button id="delete-selection" title="{% trans "Delete all selected lines/regions. (suppr)" %}" class="hide btn m-1 btn-danger fas fa-trash"></button>
      <button id="reset-masks" title="{% trans "Reset the mask of selected lines." %}" class="hide btn m-1 btn-warning fas fa-theater-masks"></button>
    </div>
  </div>
  
  <div id="trans-panel" class="col panel {{ document.default_text_direction }}">
    <div class="img-container w-100 h-100">
      <div class="zoom-container">
      <div id="part-trans">
        <svg width="100%" height="100%">
          <g id="line-template">
            <polygon fill="none" stroke="lightgrey"/>
            <path fill="none" stroke="blue" d=""></path>
            <text lengthAdjust="spacingAndGlyphs">
              <textPath></textPath>
            </text>
          </g>
        </svg>
      </div>
      </div>
    </div>
  </div>
  <div class="col-sides">
    {% if document.read_direction == 'rtl' %}
    <a id="prev-part" href="#" data-target="{{previous.pk}}" class="nav-btn nav-prev" title="{% trans "Previous" %}"><i class="fas fa-angle-right"></i></a>
    {% else %}
    <a id="next-part" href="#" data-target="{{next.pk}}" class="nav-btn nav-next" title="{% trans "Next" %}"><i class="fas fa-angle-right"></i></a>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block modals %}
<div class="modal" id="trans-modal" tabindex="-1" role="dialog" aria-labelledby="transModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        {% comment %}<h5 class="modal-title mx-2" id="modal-label">{% trans "Line" %}</h5>{% endcomment %}
        {% if document.read_direction == 'rtl' %}
        <button type="button" id="next-btn" class="btn btn-sm mr-1 btn-secondary" title="{% trans "Next" %}"><i class="fas fa-arrow-circle-left"></i></button>
        <button type="button" id="prev-btn" class="btn btn-sm btn-secondary" title="{% trans "Previous" %}"><i class="fas fa-arrow-circle-right"></i></button>
        {% else %}
        <button type="button" id="prev-btn" class="btn btn-sm mr-1 btn-secondary" title="{% trans "Previous" %}"><i class="fas fa-arrow-circle-left"></i></button>
        <button type="button" id="next-btn" class="btn btn-sm btn-secondary" title="{% trans "Next" %}"><i class="fas fa-arrow-circle-right"></i></button>
        {% endif %}
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body {{ document.default_text_direction }}">
        <div id="modal-img-container" width="80%">
          <img id="line-img" src="{{ part.image|thumbnail_url:'large' }}" draggable="false" selectable="false"/>
          <div class="overlay">
            <svg width="100%" height="100%">
              <defs>
                <mask id="modal-overlay">
                  <rect width="100%" height="100%" fill="white"/>
                  <polygon points=""/>
                </mask>
              </defs>
              <rect fill="grey" opacity="0.5" width="100%" height="100%" mask="url(#modal-overlay)" />
            </svg>
          </div>
        </div>
        
        <input type="hidden" name="transcription"/>
        <input type="hidden" name="line"/>
        <input id="trans-input" name="content" class="form-control mb-2" />
        <br>
        <a href="#" data-toggle="collapse" data-target="#history">{% trans "Show history" %}</a>
        <button type="button" id="new-version-btn" class="btn btn-sm btn-primary float-right js-push-state" title="{% trans "Save current state" %}"><i class="fas fa-save"></i></button>
        <table id="history" class="table table-sm table-striped collapse">
          <thead><tr id="no-versions"><th>{% trans "History is empty." %}</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Close</button>
        <button id="save-continue-btn" type="button" class="btn btn-sm btn-success">{% trans 'Save & Continue' %}</button>
        <button id="save-btn" type="button" class="btn btn-sm btn-success">{% trans 'Save' %}</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script type="text/javascript">
  var READ_DIRECTION = '{{document.read_direction}}';
  var DOCUMENT_ID = {{document.id}};
  var PART_ID = {{part.id}};
</script>
<script type="text/javascript" src="{% static 'js/help.js' %}"></script>
<script type="text/javascript" src="{% static 'vendor/paperjs/paper-core.min.js' %}"></script>
<script type="text/javascript" src="{% static 'vendor/color-thief.min.js' %}"></script>
<script type="text/javascript" src="{% static 'vendor/moment/moment-with-locales.min.js' %}"></script>
<script type="text/javascript" src="{% static 'vendor/moment/moment-timezone-with-data.js' %}"></script>
<script type="text/javascript" src="{% static 'vendor/undomanager.js' %}"></script>

<script type="text/javascript" src="{% static 'js/wheelzoom.js' %}"></script>
<script type="text/javascript" src="{% static 'js/baseline.editor.js' %}"></script>
<script type="text/javascript" src="{% static 'js/panels/base.js' %}"></script>
<script type="text/javascript" src="{% static 'js/panels/source.js' %}"></script>
<script type="text/javascript" src="{% static 'js/panels/binarization.js' %}"></script>
<script type="text/javascript" src="{% static 'js/panels/segmentation.js' %}"></script>
<script type="text/javascript" src="{% static 'js/panels/transcription.js' %}"></script>
<script type="text/javascript" src="{% static 'js/edit.js' %}"></script>
{% endblock %}
