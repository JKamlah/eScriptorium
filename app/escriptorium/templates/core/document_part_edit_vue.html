{% extends 'core/document_nav.html' %}
{% load i18n staticfiles %}
{% load compress %}

{% block nav-edit-active %}active{% endblock %}

{% block extra_info %}
  <span id="part-title" v-if="part">${part.title} - ${part.filename} - (${imageSize})</span>
  <span class="loading" v-if="!part">{% trans "Loading&#8230;" %}</span>
</div>
<div class="nav-item ml-auto mr-auto">
  <select v-model="selectedTranscription" id="document-transcriptions" title="{% trans 'Transcription' %}" class="form-control custom-select mb-2">
    {% for transcription in document.transcriptions.all %}
    <option value="{{ transcription.pk }}">{{ transcription.name }}</option>
    {% endfor %}
  </select>
{% endblock %}

{% block extra_nav %}
<div class="nav-item ml-auto">
  <button id="source-panel-btn" type="button" data-target="source" class="open-panel nav-item btn btn-secondary" title="{% trans "Source Image" %}"><i class="fas fa-eye"></i></button>
  <button id="seg-panel-btn" type="button" data-target="seg" class="open-panel nav-item btn btn-secondary" title="{% trans "Segmentation" %}"><i class="fas fa-align-left"></i></button>
  <button id="trans-panel-btn" type="button" data-target="trans" class="open-panel nav-item btn btn-secondary" title="{% trans "Transcription" %}"><i class="fas fa-language"></i></button>
</div>
{% endblock %}
  
{% block tab_content %}
<div class="col-sides">
  {% if document.read_direction == 'rtl' %}
  <a id="next-part" v-if="hasNext()" href="#" v-on:click="getNext" class="nav-btn nav-next" title="{% trans "Next (Page Down or Ctrl+Left Arrow)" %}"><i class="fas fa-angle-left"></i></a>
  {% else %}
  <a id="prev-part" v-if="hasPrevious()" href="#" v-on:click="getPrevious" class="nav-btn nav-prev" title="{% trans "Previous (Page Up or Ctrl+Right Arrow)" %}"><i class="fas fa-angle-left"></i></a>
  {% endif %}
  <div>
    <button id="zoom-reset" v-on:click="resetZoom" class="btn btn-sm btn-info" title="{% trans "Reset zoom." %}"><i class="fas fa-search-minus"></i></button>
    <input id="zoom-range" type="range" name="zoom-range" class="form-control-range mt-1" orient="vertical" v-bind:min="zoom.minScale" v-bind:max="zoom.maxScale" step="0.5" v-model="zoomScale">
  </div>
</div>

<SourcePanel v-bind:part="part" inline-template>
  <div class="col panel">
    <div class="tools">
      <i title="{% trans 'Source Panel' %}" class="panel-icon fas fa-eye"></i>
    </div>
    <div id="source-zoom-container" class="panel-content">
      <img class="panel-img" v-bind:src="imageSrc"/>
      <div class="overlay panel-overlay">
        <svg width="100%" height="100%">
          <defs>
            <mask id="source-overlay">
              <rect width="100%" height="100%" fill="white"/>
              <polygon points=""/>
            </mask>
          </defs>
          <rect fill="grey" opacity="0.3" width="100%" height="100%" mask="url(#source-overlay)" />
        </svg>
      </div>
    </div>
  </div>
</SourcePanel>

<SegmentationPanel v-bind:part="part" inline-template>
  <div class="col panel">
    <div class="tools">
      <i title="{% trans 'Segmentation Panel' %}" class="panel-icon fas fa-align-left"></i>
    </div>
    <div id="seg-zoom-container">
      <img class="panel-img" v-bind:src="imageSrc"/>
      <div id="segmentation-overlay" class="overlay panel-overlay">
        <svg width="100%" height="100%">
          <defs>
            <mask id="seg-overlay">
              <rect width="100%" height="100%" fill="white"/>
              <polygon points=""/>
            </mask>
          </defs>
          <rect fill="grey" opacity="0.3" width="100%" height="100%" mask="url(#seg-overlay)" />
        </svg>
      </div>
    </div>
    <button id="be-link-region" title="{% trans "Link selected lines to (the first detected) background region." %}" class="hide btn btn-info m-1 fas fa-link"></button>
    <button id="be-unlink-region" title="{% trans "Unlink selected lines from their region." %}" class="hide btn btn-info m-1 fas fa-unlink"></button>
    <button id="be-delete-point" title="{% trans "Delete selected points. (ctrl+suppr)" %}" class="hide btn btn-warning m-1 fas fa-trash"></button>
    <button id="be-merge-selection" title="{% trans "Join selected lines. (J)" %}" class="hide btn btn-info fas m-1 fa-compress-arrows-alt"></button>
    <button id="be-reverse-selection" title="{% trans "Reverse selected lines." %}" class="hide btn btn-info fas m-1 fa-arrows-alt-h"></button>
    <button id="be-delete-selection" title="{% trans "Delete all selected lines/regions. (suppr)" %}" class="hide btn m-1 btn-danger fas fa-trash"></button>
  </div>
</SegmentationPanel>

<VisuPanel v-bind:part="part" inline-template>
  <div class="col panel" >
    <div class="tools"><i title="{% trans 'Transcription Panel' %}" class="panel-icon fas fa-language"></i></div>
    <div id="visu-zoom-container" class="panel-content h-100">
      <svg v-if="part" class="w-100 h-100">
        <visuline inline-template v-for="line in part.lines" v-bind:line="line" v-bind:key="line.id">
          <g v-on:mouseover="showOverlay" v-on:mouseleave="hideOverlay" v-on:click="edit">
            <polygon fill="transparent" stroke="lightgrey" v-bind:points="maskPoints"/>
            <path v-bind:id="textPathId" fill="none" stroke="blue" v-bind:d="baselinePoints"></path>
            <text lengthAdjust="spacingAndGlyphs">
              <textPath v-if="line.transcription" v-bind:href="'#' + textPathId">${line.transcription.content}</textPath>
            </text>
          </g>
        </visuline>
      </svg>
    </div>

    <TranscriptionModal v-if="editLine" v-bind:line="editLine" inline-template>
      <div id="trans-modal" class="modal" tabindex="-1" role="dialog" aria-labelledby="transModalLabel">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              {% comment %}<h5 class="modal-title mx-2" id="modal-label">{% trans "Line" %}</h5>{% endcomment %}
              {% if document.read_direction == 'rtl' %}
              <button v-on:click="$parent.editNext()" type="button" id="next-btn" class="btn btn-sm mr-1 btn-secondary" title="{% trans "Next" %}"><i class="fas fa-arrow-circle-left"></i></button>
              <button v-on:click="$parent.editPrevious()" type="button" id="prev-btn" class="btn btn-sm btn-secondary" title="{% trans "Previous" %}"><i class="fas fa-arrow-circle-right"></i></button>
              {% else %}
              <button v-on:click="$parent.editPrevious()" type="button" id="prev-btn" class="btn btn-sm mr-1 btn-secondary" title="{% trans "Previous" %}"><i class="fas fa-arrow-circle-left"></i></button>
              <button v-on:click="$parent.editNext()" type="button" id="next-btn" class="btn btn-sm btn-secondary" title="{% trans "Next" %}"><i class="fas fa-arrow-circle-right"></i></button>
              {% endif %}
              <button type="button" class="close" v-on:click="close" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body {{ document.default_text_direction }}">
              <div id="modal-img-container" width="80%">
                <img id="line-img" v-bind:src="$parent.imageSrc" draggable="false" selectable="false"/>
                <div class="overlay">
                  <svg width="100%" height="100%">
                    <defs>
                      <mask id="modal-overlay">
                        <rect width="100%" height="100%" fill="white"/>
                        <polygon points=""/>
                      </mask>
                    </defs>
                    <rect fill="grey" opacity="0.5" width="100%" height="100%" mask="url(#modal-overlay)" />
                  </svg>
                </div>
              </div>
              
              <input type="hidden" name="transcription"/>
              <input type="hidden" name="line"/>
              <input id="trans-input" name="content" class="form-control mb-2" v-on:keyup.enter="$parent.editNext" v-model.lazy="localTranscription"/>
              <!-- <br> -->
              <!-- <a href="#" data-toggle="collapse" data-target="#history">{% trans "Show history" %}</a> -->
              <!-- <button type="button" id="new-version-btn" class="btn btn-sm btn-primary float-right js-push-state" title="{% trans "Save current state" %}"><i class="fas fa-save"></i></button> -->
              <!-- <table id="history" class="table table-sm table-striped collapse"> -->
              <!--   <thead><tr id="no-versions"><th>{% trans "History is empty." %}</th></tr></thead> -->
              <!--   <tbody></tbody> -->
              <!-- </table> -->
            </div>
          </div>
        </div>
      </div>
    </TranscriptionModal>
  </div>
</VisuPanel>

<div class="col-sides">
  {% if document.read_direction == 'rtl' %}
  <a id="prev-part" v-if="hasPrevious()" v-on:click="getPrevious" href="#" class="nav-btn nav-prev" title="{% trans "Previous (Page Up or Ctrl+Left Arrow)" %}"><i class="fas fa-angle-right"></i></a>
  {% else %}
  <a id="next-part" v-if="hasNext()" v-on:click="getNext" href="#" class="nav-btn nav-next" title="{% trans "Next (Page Down or Ctrl+Right Arrow)" %}"><i class="fas fa-angle-right"></i></a>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script type="text/javascript">
  const READ_DIRECTION = '{{document.read_direction}}';
  const TEXT_DIRECTION = '{{document.main_script.text_direction}}';
  const DOCUMENT_ID = '{{document.id}}';
  var PART_ID = {{part.id}};  // can be changed with next & previous pages
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/6.2.5/math.min.js"></script>
{% compress js file part_edit %}
    <script type="text/javascript" src="{% static 'js/help.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendor/paperjs/paper-core.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendor/color-thief.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendor/moment/moment-with-locales.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendor/moment/moment-timezone-with-data.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendor/undomanager.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendor/jquery/jquery-ui.min.js' %}"></script>

    <script type="text/javascript" src="{% static 'js/wheelzoom.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/baseline.editor.js' %}"></script>
    <!-- <script type="text/javascript" src="{% static 'js/panels/base.js' %}"></script> -->
    <!-- <script type="text/javascript" src="{% static 'js/panels/source.js' %}"></script> -->
    <!-- <script type="text/javascript" src="{% static 'js/panels/segmentation.js' %}"></script> -->
    <!-- <script type="text/javascript" src="{% static 'js/panels/transcription.js' %}"></script> -->
    <!-- <script type="text/javascript" src="{% static 'js/edit.js' %}"></script> -->

    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/http-vue-loader"></script>
    <script type="text/javascript" src="{% static 'js/panels/base_vue.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/panels/source_vue.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/panels/seg_vue.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/panels/visu_vue.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/edit_vue.js' %}"></script>

    {% endcompress %}
{% endblock %}
